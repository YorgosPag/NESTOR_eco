
"use server";

import { revalidatePath } from 'next/cache';
import { z } from 'zod';
import { getAdminDb } from "@/lib/firebase-admin";
import { 
    updateStageStatus as updateStageStatusData,
    addStageToProject,
    updateStageInProject,
    deleteStageFromProject,
    moveStageInProject
} from '@/lib/projects-data';

const UpdateStageStatusSchema = z.object({
  projectId: z.string(),
  stageId: z.string(),
  status: z.enum(['pending', 'in progress', 'completed', 'failed']),
});

export async function updateStageStatusAction(prevState: any, formData: FormData) {
  const validated = UpdateStageStatusSchema.safeParse(Object.fromEntries(formData.entries()));

  if (!validated.success) {
    return {
      success: false,
      message: 'ÎœÎ· Î­Î³ÎºÏ…ÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚.',
      errors: validated.error.flatten().fieldErrors,
    };
  }

  const { projectId, stageId, status } = validated.data;

  try {
    const db = getAdminDb();
    const success = await updateStageStatusData(db, projectId, stageId, status);
     if (!success) {
      throw new Error("Stage or project not found for status update.");
    }
    revalidatePath(`/projects/${projectId}`);
    return {
      success: true,
      message: 'Î— ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Î¿Ï… ÏƒÏ„Î±Î´Î¯Î¿Ï… ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ.',
    };
  } catch (err: any) {
    console.error('ğŸ”¥ ERROR in updateStageStatusAction:', err);
    return {
      success: false,
      message: "Î Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ Î­Î½Î± Ï„ÎµÏ‡Î½Î¹ÎºÏŒ ÏƒÏ†Î¬Î»Î¼Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.",
    };
  }
}

const AddStageSchema = z.object({
    projectId: z.string(),
    interventionMasterId: z.string(),
    title: z.string().min(3, 'ÎŸ Ï„Î¯Ï„Î»Î¿Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 3 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.'),
    deadline: z.string().min(1, 'Î— Ï€ÏÎ¿Î¸ÎµÏƒÎ¼Î¯Î± ÎµÎ¯Î½Î±Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÎ®.'),
    notes: z.string().optional(),
    assigneeContactId: z.string().optional(),
    supervisorContactId: z.string().optional(),
});

export async function addStageAction(prevState: any, formData: FormData) {
    const validatedFields = AddStageSchema.safeParse(Object.fromEntries(formData.entries()));

    if (!validatedFields.success) {
        return {
            success: false,
            errors: validatedFields.error.flatten().fieldErrors,
            message: 'Î£Ï†Î¬Î»Î¼Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¹Î¿ÏÎ¸ÏÏƒÏ„Îµ Ï„Î± Ï€ÎµÎ´Î¯Î± ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î¾Î±Î½Î¬.',
        };
    }
    const { projectId } = validatedFields.data;

    try {
        const db = getAdminDb();
        await addStageToProject(db, validatedFields.data);
    } catch (error: any) {
        console.error("ğŸ”¥ ERROR in addStageAction:", error);
        return { success: false, message: "Î Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ Î­Î½Î± Ï„ÎµÏ‡Î½Î¹ÎºÏŒ ÏƒÏ†Î¬Î»Î¼Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬." };
    }

    revalidatePath(`/projects/${projectId}`);
    return { success: true, message: 'Î¤Î¿ ÏƒÏ„Î¬Î´Î¹Î¿ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±.' };
}

const UpdateStageSchema = AddStageSchema.extend({
  stageId: z.string(),
});

export async function updateStageAction(prevState: any, formData: FormData) {
    const validatedFields = UpdateStageSchema.safeParse(Object.fromEntries(formData.entries()));

    if (!validatedFields.success) {
        return {
            success: false,
            errors: validatedFields.error.flatten().fieldErrors,
            message: 'Î£Ï†Î¬Î»Î¼Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¹Î¿ÏÎ¸ÏÏƒÏ„Îµ Ï„Î± Ï€ÎµÎ´Î¯Î± ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î¾Î±Î½Î¬.',
        };
    }
    const { projectId } = validatedFields.data;

    try {
        const db = getAdminDb();
        await updateStageInProject(db, validatedFields.data);
    } catch (error: any) {
        console.error("ğŸ”¥ ERROR in updateStageAction:", error);
        return { success: false, message: "Î Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ Î­Î½Î± Ï„ÎµÏ‡Î½Î¹ÎºÏŒ ÏƒÏ†Î¬Î»Î¼Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬." };
    }

    revalidatePath(`/projects/${projectId}`);
    return { success: true, message: 'Î¤Î¿ ÏƒÏ„Î¬Î´Î¹Î¿ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±.' };
}

const DeleteStageSchema = z.object({
  projectId: z.string(),
  stageId: z.string(),
});

export async function deleteStageAction(prevState: any, formData: FormData) {
    const validatedFields = DeleteStageSchema.safeParse(Object.fromEntries(formData.entries()));

    if (!validatedFields.success) {
        return { success: false, message: 'ÎœÎ· Î­Î³ÎºÏ…ÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.' };
    }
    const { projectId } = validatedFields.data;

    try {
        const db = getAdminDb();
        await deleteStageFromProject(db, validatedFields.data);
    } catch (error: any) {
        console.error("ğŸ”¥ ERROR in deleteStageAction:", error);
        return { success: false, message: "Î Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ Î­Î½Î± Ï„ÎµÏ‡Î½Î¹ÎºÏŒ ÏƒÏ†Î¬Î»Î¼Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬." };
    }

    revalidatePath(`/projects/${projectId}`);
    return { success: true, message: 'Î¤Î¿ ÏƒÏ„Î¬Î´Î¹Î¿ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±.' };
}

const MoveStageSchema = z.object({
  projectId: z.string(),
  interventionMasterId: z.string(),
  stageId: z.string(),
  direction: z.enum(['up', 'down']),
});

export async function moveStageAction(prevState: any, formData: FormData) {
    const validatedFields = MoveStageSchema.safeParse(Object.fromEntries(formData.entries()));
    if (!validatedFields.success) {
        return { success: false, message: 'ÎœÎ· Î­Î³ÎºÏ…ÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.' };
    }
    const { projectId } = validatedFields.data;

    try {
        const db = getAdminDb();
        const result = await moveStageInProject(db, validatedFields.data);
        if (!result.success) {
            return { success: true, message: result.message };
        }
    } catch (error: any) {
        console.error("ğŸ”¥ ERROR in moveStageAction:", error);
        return { success: false, message: "Î Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ Î­Î½Î± Ï„ÎµÏ‡Î½Î¹ÎºÏŒ ÏƒÏ†Î¬Î»Î¼Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬." };
    }

    revalidatePath(`/projects/${projectId}`);
    return { success: true, message: 'Î— ÏƒÎµÎ¹ÏÎ¬ Î¬Î»Î»Î±Î¾Îµ.' };
}
